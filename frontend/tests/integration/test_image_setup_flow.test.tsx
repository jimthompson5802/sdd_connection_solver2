/**\n * Integration test for image setup flow (paste → extract → puzzle).\n * \n * Tests the complete user workflow from pasting an image to starting a puzzle.\n */\n\nimport React from 'react';\nimport { render, screen, fireEvent, waitFor } from '@testing-library/react';\nimport '@testing-library/jest-dom';\nimport { ImagePuzzleSetup } from '../../components/ImagePuzzleSetup';\nimport * as api from '../../services/api';\n\n// Mock the API service\njest.mock('../../services/api');\nconst mockApi = api as jest.Mocked<typeof api>;\n\n// Mock Clipboard API\nconst mockClipboard = {\n  read: jest.fn(),\n  readText: jest.fn(),\n  write: jest.fn(),\n  writeText: jest.fn()\n};\n\n// Mock File and Blob APIs\nconst mockFileReader = {\n  readAsDataURL: jest.fn(),\n  result: '',\n  onload: null,\n  onerror: null\n};\n\nglobal.FileReader = jest.fn(() => mockFileReader) as any;\nglobal.URL.createObjectURL = jest.fn(() => 'mock-object-url');\nglobal.URL.revokeObjectURL = jest.fn();\n\n// Add clipboard to navigator\nObject.defineProperty(navigator, 'clipboard', {\n  value: mockClipboard,\n  writable: true\n});\n\ndescribe('Image Setup Flow Integration', () => {\n  const mockProps = {\n    onImageSetup: jest.fn(),\n    providers: [\n      { type: 'openai', name: 'OpenAI' },\n      { type: 'ollama', name: 'Ollama' }\n    ] as any,\n    defaultProvider: { type: 'openai', name: 'OpenAI' } as any,\n    defaultModel: 'gpt-4-vision-preview',\n    onError: jest.fn()\n  };\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    mockFileReader.result = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChAHGArbiOgAAAABJRU5ErkJggg==';\n  });\n\n  afterEach(() => {\n    jest.restoreAllMocks();\n  });\n\n  describe('Complete Image to Puzzle Flow', () => {\n    it('should complete full workflow: paste image → extract words → start puzzle', async () => {\n      // Arrange\n      const mockExtractedWords = [\n        'apple', 'banana', 'cherry', 'date',\n        'elderberry', 'fig', 'grape', 'honeydew',\n        'kiwi', 'lemon', 'mango', 'nectarine', \n        'orange', 'papaya', 'quince', 'raspberry'\n      ];\n      \n      mockApi.setupPuzzleFromImage = jest.fn().mockResolvedValue({\n        remaining_words: mockExtractedWords,\n        status: 'success'\n      });\n\n      // Create mock image blob for paste event\n      const mockImageBlob = new Blob(['fake image data'], { type: 'image/png' });\n      const mockClipboardItem = {\n        types: ['image/png'],\n        getType: jest.fn().mockResolvedValue(mockImageBlob)\n      };\n      mockClipboard.read.mockResolvedValue([mockClipboardItem]);\n\n      // Act - Render component\n      render(<ImagePuzzleSetup {...mockProps} />);\n      \n      // Verify initial state\n      expect(screen.getByText(/paste image here/i)).toBeInTheDocument();\n      expect(screen.getByText(/cmd.*v.*ctrl.*v/i)).toBeInTheDocument();\n      \n      // Act - Simulate paste event\n      const pasteArea = screen.getByTestId('image-paste-area');\n      fireEvent.paste(pasteArea, {\n        clipboardData: {\n          items: [{\n            kind: 'file',\n            type: 'image/png',\n            getAsFile: () => mockImageBlob\n          }]\n        }\n      });\n\n      // Wait for image processing\n      await waitFor(() => {\n        expect(mockFileReader.readAsDataURL).toHaveBeenCalledWith(mockImageBlob);\n      });\n\n      // Simulate FileReader onload\n      mockFileReader.onload({ target: { result: mockFileReader.result } } as any);\n\n      // Verify image preview appears\n      await waitFor(() => {\n        expect(screen.getByAltText(/pasted image preview/i)).toBeInTheDocument();\n      });\n\n      // Verify provider and model dropdowns are populated\n      expect(screen.getByDisplayValue('openai')).toBeInTheDocument();\n      expect(screen.getByDisplayValue('gpt-4-vision-preview')).toBeInTheDocument();\n      \n      // Verify Setup Puzzle button is enabled\n      const setupButton = screen.getByRole('button', { name: /setup puzzle/i });\n      expect(setupButton).toBeEnabled();\n\n      // Act - Click Setup Puzzle button\n      fireEvent.click(setupButton);\n\n      // Verify loading state\n      await waitFor(() => {\n        expect(setupButton).toBeDisabled();\n        expect(screen.getByText(/extracting words/i)).toBeInTheDocument();\n      });\n\n      // Verify API call\n      await waitFor(() => {\n        expect(mockApi.setupPuzzleFromImage).toHaveBeenCalledWith({\n          image_base64: expect.stringMatching(/^iVBORw0KGgo/), // Base64 without prefix\n          image_mime: 'image/png',\n          provider_type: 'openai',\n          model_name: 'gpt-4-vision-preview'\n        });\n      });\n\n      // Verify success callback\n      await waitFor(() => {\n        expect(mockProps.onImageSetup).toHaveBeenCalledWith(mockExtractedWords);\n      });\n\n      // Verify loading state cleared\n      await waitFor(() => {\n        expect(setupButton).toBeEnabled();\n        expect(screen.queryByText(/extracting words/i)).not.toBeInTheDocument();\n      });\n    });\n\n    it('should handle API errors gracefully', async () => {\n      // Arrange\n      mockApi.setupPuzzleFromImage = jest.fn().mockRejectedValue(new Error('LLM unable to extract puzzle words'));\n      \n      const mockImageBlob = new Blob(['fake image data'], { type: 'image/png' });\n      const mockClipboardItem = {\n        types: ['image/png'],\n        getType: jest.fn().mockResolvedValue(mockImageBlob)\n      };\n      mockClipboard.read.mockResolvedValue([mockClipboardItem]);\n\n      // Act\n      render(<ImagePuzzleSetup {...mockProps} />);\n      \n      // Paste image\n      const pasteArea = screen.getByTestId('image-paste-area');\n      fireEvent.paste(pasteArea, {\n        clipboardData: {\n          items: [{\n            kind: 'file',\n            type: 'image/png', \n            getAsFile: () => mockImageBlob\n          }]\n        }\n      });\n\n      await waitFor(() => {\n        mockFileReader.onload({ target: { result: mockFileReader.result } } as any);\n      });\n\n      // Click Setup Puzzle button\n      const setupButton = screen.getByRole('button', { name: /setup puzzle/i });\n      fireEvent.click(setupButton);\n\n      // Verify error handling\n      await waitFor(() => {\n        expect(screen.getByText(/llm unable to extract puzzle words/i)).toBeInTheDocument();\n        expect(mockProps.onError).toHaveBeenCalledWith('LLM unable to extract puzzle words');\n      });\n\n      // Verify image and selections preserved for retry\n      expect(screen.getByAltText(/pasted image preview/i)).toBeInTheDocument();\n      expect(setupButton).toBeEnabled();\n    });\n\n    it('should validate image size before API call', async () => {\n      // Arrange - Create oversized image data\n      const largeImageData = 'data:image/png;base64,' + 'x'.repeat(7000000); // >5MB\n      mockFileReader.result = largeImageData;\n      \n      const mockImageBlob = new Blob(['x'.repeat(6000000)], { type: 'image/png' }); // Large blob\n      const mockClipboardItem = {\n        types: ['image/png'],\n        getType: jest.fn().mockResolvedValue(mockImageBlob)\n      };\n      mockClipboard.read.mockResolvedValue([mockClipboardItem]);\n\n      // Act\n      render(<ImagePuzzleSetup {...mockProps} />);\n      \n      const pasteArea = screen.getByTestId('image-paste-area');\n      fireEvent.paste(pasteArea, {\n        clipboardData: {\n          items: [{\n            kind: 'file',\n            type: 'image/png',\n            getAsFile: () => mockImageBlob\n          }]\n        }\n      });\n\n      await waitFor(() => {\n        mockFileReader.onload({ target: { result: largeImageData } } as any);\n      });\n\n      // Verify size validation error\n      await waitFor(() => {\n        expect(screen.getByText(/image too large.*max 5mb/i)).toBeInTheDocument();\n      });\n\n      // Verify Setup Puzzle button disabled\n      const setupButton = screen.getByRole('button', { name: /setup puzzle/i });\n      expect(setupButton).toBeDisabled();\n\n      // Verify API not called\n      expect(mockApi.setupPuzzleFromImage).not.toHaveBeenCalled();\n    });\n\n    it('should validate image format', async () => {\n      // Arrange - Invalid image format\n      const mockTextBlob = new Blob(['text content'], { type: 'text/plain' });\n      const mockClipboardItem = {\n        types: ['text/plain'],\n        getType: jest.fn().mockResolvedValue(mockTextBlob)\n      };\n      mockClipboard.read.mockResolvedValue([mockClipboardItem]);\n\n      // Act\n      render(<ImagePuzzleSetup {...mockProps} />);\n      \n      const pasteArea = screen.getByTestId('image-paste-area');\n      fireEvent.paste(pasteArea, {\n        clipboardData: {\n          items: [{\n            kind: 'file',\n            type: 'text/plain',\n            getAsFile: () => mockTextBlob\n          }]\n        }\n      });\n\n      // Verify format validation error\n      await waitFor(() => {\n        expect(screen.getByText(/please paste a valid image/i)).toBeInTheDocument();\n      });\n\n      // Verify Setup Puzzle button disabled\n      const setupButton = screen.getByRole('button', { name: /setup puzzle/i });\n      expect(setupButton).toBeDisabled();\n    });\n  });\n\n  describe('Provider Selection Integration', () => {\n    it('should update model options when provider changes', async () => {\n      // This test will be implemented when provider/model dropdowns are functional\n      render(<ImagePuzzleSetup {...mockProps} />);\n      \n      // Verify basic provider dropdown exists\n      expect(screen.getByDisplayValue('openai')).toBeInTheDocument();\n    });\n  });\n\n  describe('Accessibility Integration', () => {\n    it('should support keyboard navigation and screen readers', () => {\n      render(<ImagePuzzleSetup {...mockProps} />);\n      \n      // Verify ARIA labels and roles\n      expect(screen.getByRole('button', { name: /setup puzzle/i })).toBeInTheDocument();\n      expect(screen.getByLabelText(/provider/i)).toBeInTheDocument();\n      expect(screen.getByLabelText(/model/i)).toBeInTheDocument();\n    });\n  });\n});